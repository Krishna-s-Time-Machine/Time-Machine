---
import { LOCALE, SITE } from "@config";
import "@styles/base.css";
import { ViewTransitions } from "astro:transitions";

const googleSiteVerification = import.meta.env.PUBLIC_GOOGLE_SITE_VERIFICATION;
const scrollSmooth = SITE.scrollSmooth ?? false;
---

<!doctype html>
<html lang={`${LOCALE.lang ?? "en"}`} class={`${scrollSmooth ? "scroll-smooth" : ""}`}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="canonical" href={new URL(Astro.url.pathname, Astro.site).href} />
    <meta name="generator" content={Astro.generator} />

    <title>{SITE.title}</title>
    <meta name="title" content={SITE.title} />
    <meta name="description" content={SITE.desc} />
    <meta name="author" content={SITE.author} />
    <link rel="sitemap" href="/sitemap-index.xml" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet"/>

    <meta name="theme-color" content="" />

    {
      googleSiteVerification && (
        <meta name="google-site-verification" content={googleSiteVerification} />
      )
    }

    <ViewTransitions />
    <script is:inline src="/toggle-theme.js"></script>
  </head>
  <body>
    <slot />

    <!-- ðŸŽµ Persistent Background Music (Playlist) -->
    <audio id="bg-music">
      <source id="audio-source" type="audio/mpeg">
      Your browser does not support audio playback.
    </audio>

    <!-- ðŸŽµ JavaScript for Persistent Playlist -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        if (!window.__persistentAudio) {
          window.__persistentAudio = document.getElementById("bg-music");
          window.__persistentAudioSource = document.getElementById("audio-source");

          // ðŸŽµ Playlist (Adjusted file paths)
          window.__playlist = [
            "/music/HUT/1.mp3",
            "/music/HUT/2.mp3",
            "/music/HUT/3.mp3",
            "/music/HUT/4.mp3",
            "/music/HUT/5.mp3",
            "/music/HUT/6.mp3",
            "/music/HUT/7.mp3",
            "/music/HUT/8.mp3",
            "/music/HUT/9.mp3",
            "/music/HUT/10.mp3",
            "/music/HUT/11.mp3",
            "/music/HUT/12.mp3",
            "/music/HUT/13.mp3",
            "/music/HUT/14.mp3",
            "/music/HUT/15.mp3",
            "/music/HUT/16.mp3",
            "/music/HUT/17.mp3",
            "/music/HUT/18.mp3",
            "/music/HUT/19.mp3",
            "/music/HUT/20.mp3",
            "/music/HUT/21.mp3",
            "/music/HUT/22.mp3",
            "/music/HUT/23.mp3",
            "/music/HUT/24.mp3",
            "/music/HUT/25.mp3",
            "/music/HUT/26.mp3"
          ];

          window.__currentTrack = parseInt(sessionStorage.getItem("currentTrack")) || 0;
          window.__persistentAudioSource.src = window.__playlist[window.__currentTrack];

          function playCurrentTrack() {
            window.__persistentAudioSource.src = window.__playlist[window.__currentTrack];
            window.__persistentAudio.load();
            window.__persistentAudio.play().catch(err => {
              console.log("Autoplay blocked:", err);
              document.body.addEventListener("click", playCurrentTrack, { once: true });
            });
          }

          // Play next song when current ends
          window.__persistentAudio.addEventListener("ended", function () {
            window.__currentTrack = (window.__currentTrack + 1) % window.__playlist.length;
            sessionStorage.setItem("currentTrack", window.__currentTrack);
            playCurrentTrack();
          });

          // Restore position
          const savedTime = sessionStorage.getItem("audioTime");
          if (savedTime) {
            window.__persistentAudio.currentTime = parseFloat(savedTime);
          }

          // Save time before navigating
          window.addEventListener("beforeunload", function () {
            sessionStorage.setItem("audioTime", window.__persistentAudio.currentTime);
          });

          playCurrentTrack();
        }

        // Ensure audio is kept when navigating between pages
        document.addEventListener("astro:after-swap", function () {
          document.body.appendChild(window.__persistentAudio);
        });
      });
    </script>

  </body>
</html>